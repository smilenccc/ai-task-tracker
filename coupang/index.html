<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coupang é…·æ¾ â€” è³¼ç‰©çµ±è¨ˆå„€è¡¨æ¿</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0f1117;
      --card: #1a1d28;
      --card-hover: #22263a;
      --border: #2a2e3f;
      --text: #e4e4e7;
      --text-dim: #9ca3af;
      --accent: #c33332;
      --accent-light: #e04444;
      --green: #22c55e;
      --yellow: #eab308;
      --red: #ef4444;
      --blue: #3b82f6;
      --purple: #a855f7;
      --radius: 12px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .header {
      background: linear-gradient(135deg, var(--accent) 0%, #8b1a1a 100%);
      padding: 2rem;
      text-align: center;
    }
    .header h1 { font-size: 1.8rem; font-weight: 700; }
    .header p { color: rgba(255,255,255,0.75); font-size: 0.9rem; margin-top: 0.3rem; }

    .container { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }

    /* â”€â”€ Stats Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .stat-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.2rem;
      transition: background 0.2s;
    }
    .stat-card:hover { background: var(--card-hover); }
    .stat-card .label { font-size: 0.8rem; color: var(--text-dim); margin-bottom: 0.3rem; }
    .stat-card .value { font-size: 1.5rem; font-weight: 700; }
    .stat-card .sub { font-size: 0.75rem; color: var(--text-dim); margin-top: 0.3rem; }
    .stat-card .value.green { color: var(--green); }
    .stat-card .value.red { color: var(--red); }
    .stat-card .value.blue { color: var(--blue); }
    .stat-card .value.purple { color: var(--purple); }
    .stat-card .value.accent { color: var(--accent-light); }
    .stat-card .value.yellow { color: var(--yellow); }

    /* â”€â”€ Budget Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .budget-section {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.2rem;
      margin-bottom: 1.5rem;
    }
    .budget-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.8rem;
    }
    .budget-header h3 { font-size: 1rem; }
    .budget-input {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .budget-input label { font-size: 0.8rem; color: var(--text-dim); }
    .budget-input input {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      padding: 0.3rem 0.6rem;
      width: 120px;
      font-size: 0.9rem;
    }
    .budget-bar-bg {
      background: var(--bg);
      border-radius: 8px;
      height: 28px;
      overflow: hidden;
      position: relative;
    }
    .budget-bar-fill {
      height: 100%;
      border-radius: 8px;
      transition: width 0.5s ease, background 0.3s;
      display: flex;
      align-items: center;
      padding-left: 10px;
      font-size: 0.75rem;
      font-weight: 600;
      color: #fff;
      min-width: fit-content;
    }
    .budget-bar-fill.green { background: var(--green); }
    .budget-bar-fill.yellow { background: var(--yellow); color: #000; }
    .budget-bar-fill.red { background: var(--red); }
    .budget-info {
      display: flex;
      justify-content: space-between;
      margin-top: 0.5rem;
      font-size: 0.8rem;
      color: var(--text-dim);
    }

    /* â”€â”€ Charts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    @media (max-width: 768px) {
      .charts-grid { grid-template-columns: 1fr; }
    }
    .chart-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.2rem;
    }
    .chart-card h3 {
      font-size: 1rem;
      margin-bottom: 1rem;
    }
    .chart-container {
      position: relative;
      height: 280px;
    }

    /* â”€â”€ Habits Section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .habits-section {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.2rem;
      margin-bottom: 1.5rem;
    }
    .habits-section h3 { font-size: 1rem; margin-bottom: 0.8rem; }
    .habits-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }
    .habit-item {
      background: var(--bg);
      border-radius: 8px;
      padding: 1rem;
    }
    .habit-item .habit-label { font-size: 0.8rem; color: var(--text-dim); }
    .habit-item .habit-value { font-size: 1.1rem; font-weight: 600; margin-top: 0.2rem; }

    /* â”€â”€ Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .controls {
      display: flex;
      gap: 0.8rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .controls input, .controls select {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      padding: 0.5rem 0.8rem;
      font-size: 0.9rem;
    }
    .controls input { flex: 1; min-width: 200px; }
    .controls select { min-width: 140px; }
    .controls input:focus, .controls select:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .table-wrapper {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }
    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.2rem;
      border-bottom: 1px solid var(--border);
    }
    .table-header h3 { font-size: 1rem; }
    .table-header .count { font-size: 0.85rem; color: var(--text-dim); }

    table { width: 100%; border-collapse: collapse; }
    th {
      text-align: left;
      padding: 0.7rem 1rem;
      font-size: 0.75rem;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      user-select: none;
    }
    th:hover { color: var(--text); }
    th .sort-icon { margin-left: 4px; font-size: 0.65rem; }
    td {
      padding: 0.7rem 1rem;
      font-size: 0.9rem;
      border-bottom: 1px solid var(--border);
    }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: var(--card-hover); }

    .category-badge {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 99px;
      font-size: 0.7rem;
      font-weight: 500;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
    }

    .price { font-weight: 600; font-variant-numeric: tabular-nums; }

    /* â”€â”€ Empty State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-dim);
    }
    .empty-state .icon { font-size: 3rem; margin-bottom: 1rem; }
    .empty-state h3 { font-size: 1.2rem; color: var(--text); margin-bottom: 0.5rem; }
    .empty-state p { font-size: 0.9rem; max-width: 400px; margin: 0 auto; }
    .empty-state code {
      display: inline-block;
      background: var(--bg);
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.85rem;
      margin-top: 0.8rem;
    }

    /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .footer {
      text-align: center;
      padding: 2rem;
      font-size: 0.8rem;
      color: var(--text-dim);
    }

    /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 600px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .controls { flex-direction: column; }
      .controls input, .controls select { min-width: 100%; }
      .budget-header { flex-direction: column; gap: 0.5rem; }
      th, td { padding: 0.5rem 0.6rem; font-size: 0.8rem; }
    }
  </style>
</head>
<body>

<div class="header">
  <h1>Coupang é…·æ¾ è³¼ç‰©çµ±è¨ˆ</h1>
  <p id="lastUpdated">è¼‰å…¥ä¸­...</p>
</div>

<div class="container">

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="label">ç¸½æ¶ˆè²»é‡‘é¡</div>
      <div class="value accent" id="totalSpent">$0</div>
      <div class="sub" id="avgPerOrder">å¹³å‡æ¯ç­† $0</div>
    </div>
    <div class="stat-card">
      <div class="label">è¨‚å–®æ•¸é‡</div>
      <div class="value blue" id="totalOrders">0</div>
      <div class="sub" id="totalItems">å…± 0 ä»¶å•†å“</div>
    </div>
    <div class="stat-card">
      <div class="label">æœ¬æœˆæ¶ˆè²»</div>
      <div class="value green" id="thisMonthSpent">$0</div>
      <div class="sub" id="thisMonthOrders">0 ç­†è¨‚å–®</div>
    </div>
    <div class="stat-card">
      <div class="label">æœˆå‡æ¶ˆè²»</div>
      <div class="value purple" id="monthlyAvg">$0</div>
      <div class="sub" id="activeMonths">å…± 0 å€‹æœˆ</div>
    </div>
    <div class="stat-card">
      <div class="label">æœ€è²´å•†å“</div>
      <div class="value red" id="mostExpensive">â€”</div>
      <div class="sub" id="mostExpensiveName">â€”</div>
    </div>
    <div class="stat-card">
      <div class="label">æœ€ä¾¿å®œå•†å“</div>
      <div class="value yellow" id="cheapest">â€”</div>
      <div class="sub" id="cheapestName">â€”</div>
    </div>
  </div>

  <!-- Budget Tracker -->
  <div class="budget-section">
    <div class="budget-header">
      <h3>æœˆé ç®—è¿½è¹¤</h3>
      <div class="budget-input">
        <label>æœˆé ç®— NT$</label>
        <input type="number" id="budgetInput" placeholder="5000" min="0" step="500">
      </div>
    </div>
    <div class="budget-bar-bg">
      <div class="budget-bar-fill green" id="budgetBar" style="width: 0%"></div>
    </div>
    <div class="budget-info">
      <span id="budgetSpent">å·²èŠ±è²» $0</span>
      <span id="budgetRemaining">å‰©é¤˜ $0</span>
    </div>
  </div>

  <!-- Charts -->
  <div class="charts-grid">
    <div class="chart-card">
      <h3>æ¶ˆè²»åˆ†é¡åˆ†å¸ƒ</h3>
      <div class="chart-container">
        <canvas id="categoryChart"></canvas>
      </div>
    </div>
    <div class="chart-card">
      <h3>æ¯æœˆæ¶ˆè²»è¶¨å‹¢</h3>
      <div class="chart-container">
        <canvas id="trendChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Spending Habits -->
  <div class="habits-section">
    <h3>æ¶ˆè²»ç¿’æ…£åˆ†æ</h3>
    <div class="habits-grid">
      <div class="habit-item">
        <div class="habit-label">æœ€å¸¸è³¼ç‰©æ—¥</div>
        <div class="habit-value" id="favDay">â€”</div>
      </div>
      <div class="habit-item">
        <div class="habit-label">æœ€é«˜æ¶ˆè²»æœˆ</div>
        <div class="habit-value" id="topMonth">â€”</div>
      </div>
      <div class="habit-item">
        <div class="habit-label">æœ€å¸¸è²·çš„åˆ†é¡</div>
        <div class="habit-value" id="topCategory">â€”</div>
      </div>
      <div class="habit-item">
        <div class="habit-label">å¹³å‡è³¼ç‰©é »ç‡</div>
        <div class="habit-value" id="frequency">â€”</div>
      </div>
    </div>
  </div>

  <!-- Search & Filter -->
  <div class="controls">
    <input type="text" id="searchInput" placeholder="æœå°‹å•†å“åç¨±...">
    <select id="categoryFilter">
      <option value="">å…¨éƒ¨åˆ†é¡</option>
    </select>
    <select id="sortSelect">
      <option value="date-desc">æ—¥æœŸï¼ˆæ–°â†’èˆŠï¼‰</option>
      <option value="date-asc">æ—¥æœŸï¼ˆèˆŠâ†’æ–°ï¼‰</option>
      <option value="price-desc">é‡‘é¡ï¼ˆé«˜â†’ä½ï¼‰</option>
      <option value="price-asc">é‡‘é¡ï¼ˆä½â†’é«˜ï¼‰</option>
      <option value="name-asc">åç¨± Aâ†’Z</option>
    </select>
  </div>

  <!-- Orders Table -->
  <div class="table-wrapper">
    <div class="table-header">
      <h3>è¨‚å–®æ˜ç´°</h3>
      <span class="count" id="filteredCount">0 ç­†</span>
    </div>
    <div id="tableContent">
      <table>
        <thead>
          <tr>
            <th data-sort="date">æ—¥æœŸ <span class="sort-icon"></span></th>
            <th data-sort="name">å•†å“</th>
            <th data-sort="category">åˆ†é¡</th>
            <th data-sort="price">é‡‘é¡ <span class="sort-icon"></span></th>
            <th data-sort="status">ç‹€æ…‹</th>
          </tr>
        </thead>
        <tbody id="ordersBody"></tbody>
      </table>
    </div>
    <div class="empty-state" id="emptyState" style="display:none;">
      <div class="icon">ğŸ›’</div>
      <h3>å°šç„¡è¨‚å–®è³‡æ–™</h3>
      <p>è«‹å…ˆåŸ·è¡Œ Coupang çˆ¬èŸ²ä¾†å–å¾—è¨‚å–®è³‡æ–™</p>
      <code>cd coupang-scraper && npm run scrape</code>
    </div>
  </div>

</div>

<div class="footer">
  <p>Coupang é…·æ¾è³¼ç‰©çµ±è¨ˆå„€è¡¨æ¿ â€” è³‡æ–™è‡ªå‹•çˆ¬å– & åŒæ­¥</p>
</div>

<script>
// â”€â”€ Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allPurchases = [];
let filteredPurchases = [];
let categoryChart = null;
let trendChart = null;

const CATEGORY_COLORS = {
  'é£Ÿå“/é£²æ–™': '#ef4444',
  '3C/é›»å­': '#3b82f6',
  'æ—¥ç”¨å“/æ¸…æ½”': '#22c55e',
  'ç¾å¦/ä¿é¤Š': '#ec4899',
  'æœé£¾/é…ä»¶': '#a855f7',
  'å±…å®¶/å‚¢ä¿±': '#f97316',
  'å¥åº·/é‹å‹•': '#14b8a6',
  'æ¯å¬°/å¯µç‰©': '#f59e0b',
  'æ›¸ç±/æ–‡å…·': '#6366f1',
  'å…¶ä»–': '#6b7280',
};

const WEEKDAYS = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  try {
    // Try server first, fallback to relative path
    const resp = await fetch('/purchases.json').catch(() => fetch('../purchases.json'));
    if (!resp.ok) throw new Error('Failed to load');
    const data = await resp.json();
    allPurchases = data.purchases || [];
    filteredPurchases = [...allPurchases];

    const lastUpdated = data.meta?.lastUpdated;
    if (lastUpdated) {
      document.getElementById('lastUpdated').textContent =
        `æœ€å¾Œæ›´æ–°ï¼š${new Date(lastUpdated).toLocaleString('zh-TW')}`;
    }

    // Load saved budget
    const savedBudget = localStorage.getItem('coupang-budget');
    if (savedBudget) {
      document.getElementById('budgetInput').value = savedBudget;
    }

    populateCategories();
    updateAll();
    setupListeners();
  } catch (err) {
    console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', err);
    document.getElementById('lastUpdated').textContent = 'è¼‰å…¥å¤±æ•— â€” è«‹ç¢ºèª purchases.json å­˜åœ¨';
    showEmptyState();
  }
}

function setupListeners() {
  document.getElementById('searchInput').addEventListener('input', applyFilters);
  document.getElementById('categoryFilter').addEventListener('change', applyFilters);
  document.getElementById('sortSelect').addEventListener('change', applyFilters);
  document.getElementById('budgetInput').addEventListener('input', (e) => {
    localStorage.setItem('coupang-budget', e.target.value);
    updateBudget();
  });
}

// â”€â”€ Formatting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(n) {
  return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(n);
}

function fmtNum(n) {
  return new Intl.NumberFormat('zh-TW').format(Math.round(n));
}

// â”€â”€ Filters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function populateCategories() {
  const cats = [...new Set(allPurchases.map(p => p.category).filter(Boolean))].sort();
  const sel = document.getElementById('categoryFilter');
  cats.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    sel.appendChild(opt);
  });
}

function applyFilters() {
  const search = document.getElementById('searchInput').value.toLowerCase();
  const cat = document.getElementById('categoryFilter').value;
  const sort = document.getElementById('sortSelect').value;

  filteredPurchases = allPurchases.filter(p => {
    if (search && !(p.name || '').toLowerCase().includes(search)) return false;
    if (cat && p.category !== cat) return false;
    return true;
  });

  // Sort
  const [key, dir] = sort.split('-');
  filteredPurchases.sort((a, b) => {
    let va, vb;
    if (key === 'date') { va = a.date || ''; vb = b.date || ''; }
    else if (key === 'price') { va = a.price || 0; vb = b.price || 0; }
    else if (key === 'name') { va = (a.name || '').toLowerCase(); vb = (b.name || '').toLowerCase(); }
    else { va = a[key] || ''; vb = b[key] || ''; }
    if (va < vb) return dir === 'asc' ? -1 : 1;
    if (va > vb) return dir === 'asc' ? 1 : -1;
    return 0;
  });

  renderTable();
  document.getElementById('filteredCount').textContent = `${filteredPurchases.length} ç­†`;
}

// â”€â”€ Update All â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateAll() {
  updateStats();
  updateBudget();
  updateCharts();
  updateHabits();
  applyFilters();
}

// â”€â”€ Stats Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateStats() {
  const total = allPurchases.reduce((s, p) => s + (p.price || 0), 0);
  const count = allPurchases.length;
  const avg = count ? total / count : 0;

  document.getElementById('totalSpent').textContent = fmt(total);
  document.getElementById('totalOrders').textContent = fmtNum(count);
  document.getElementById('avgPerOrder').textContent = `å¹³å‡æ¯ç­† ${fmt(avg)}`;
  document.getElementById('totalItems').textContent = `å…± ${fmtNum(allPurchases.reduce((s, p) => s + (p.quantity || 1), 0))} ä»¶å•†å“`;

  // This month
  const now = new Date();
  const thisMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
  const thisMonthPurchases = allPurchases.filter(p => (p.date || '').startsWith(thisMonth));
  const thisMonthTotal = thisMonthPurchases.reduce((s, p) => s + (p.price || 0), 0);
  document.getElementById('thisMonthSpent').textContent = fmt(thisMonthTotal);
  document.getElementById('thisMonthOrders').textContent = `${thisMonthPurchases.length} ç­†è¨‚å–®`;

  // Monthly average
  const months = getMonthlyData();
  const monthKeys = Object.keys(months);
  const monthlyAvg = monthKeys.length ? total / monthKeys.length : 0;
  document.getElementById('monthlyAvg').textContent = fmt(monthlyAvg);
  document.getElementById('activeMonths').textContent = `å…± ${monthKeys.length} å€‹æœˆ`;

  // Most expensive / cheapest
  if (count > 0) {
    const sorted = [...allPurchases].sort((a, b) => (b.price || 0) - (a.price || 0));
    const most = sorted[0];
    const least = sorted[sorted.length - 1];
    document.getElementById('mostExpensive').textContent = fmt(most.price || 0);
    document.getElementById('mostExpensiveName').textContent = truncate(most.name || 'â€”', 20);
    document.getElementById('cheapest').textContent = fmt(least.price || 0);
    document.getElementById('cheapestName').textContent = truncate(least.name || 'â€”', 20);
  }

  if (count === 0) showEmptyState();
}

function truncate(s, max) {
  return s.length > max ? s.slice(0, max) + '...' : s;
}

// â”€â”€ Budget â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateBudget() {
  const budget = parseFloat(document.getElementById('budgetInput').value) || 0;
  const now = new Date();
  const thisMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
  const spent = allPurchases
    .filter(p => (p.date || '').startsWith(thisMonth))
    .reduce((s, p) => s + (p.price || 0), 0);

  const bar = document.getElementById('budgetBar');
  const pct = budget > 0 ? Math.min((spent / budget) * 100, 100) : 0;

  bar.style.width = `${pct}%`;
  bar.textContent = budget > 0 ? `${Math.round(pct)}%` : '';

  bar.className = 'budget-bar-fill ' + (pct < 60 ? 'green' : pct < 85 ? 'yellow' : 'red');

  document.getElementById('budgetSpent').textContent = `å·²èŠ±è²» ${fmt(spent)}`;
  document.getElementById('budgetRemaining').textContent =
    budget > 0 ? `å‰©é¤˜ ${fmt(Math.max(budget - spent, 0))}` : 'è«‹è¨­å®šé ç®—';
}

// â”€â”€ Charts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getMonthlyData() {
  const months = {};
  allPurchases.forEach(p => {
    if (!p.date) return;
    const key = p.date.slice(0, 7);
    months[key] = (months[key] || 0) + (p.price || 0);
  });
  return months;
}

function getCategoryData() {
  const cats = {};
  allPurchases.forEach(p => {
    const cat = p.category || 'å…¶ä»–';
    cats[cat] = (cats[cat] || 0) + (p.price || 0);
  });
  return cats;
}

function updateCharts() {
  updateCategoryChart();
  updateTrendChart();
}

function updateCategoryChart() {
  const data = getCategoryData();
  const labels = Object.keys(data);
  const values = Object.values(data);
  const colors = labels.map(l => CATEGORY_COLORS[l] || CATEGORY_COLORS['å…¶ä»–']);

  const ctx = document.getElementById('categoryChart').getContext('2d');
  if (categoryChart) categoryChart.destroy();

  if (labels.length === 0) return;

  categoryChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: colors,
        borderColor: 'transparent',
        borderWidth: 0,
      }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right',
          labels: { color: '#9ca3af', font: { size: 11 }, padding: 8, boxWidth: 12 },
        },
        tooltip: {
          callbacks: {
            label: (ctx) => {
              const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
              const pct = ((ctx.raw / total) * 100).toFixed(1);
              return `${ctx.label}: ${fmt(ctx.raw)} (${pct}%)`;
            },
          },
        },
      },
    },
  });
}

function updateTrendChart() {
  const monthlyData = getMonthlyData();
  const keys = Object.keys(monthlyData).sort();
  const values = keys.map(k => monthlyData[k]);
  const labels = keys.map(k => {
    const [y, m] = k.split('-');
    return `${y}/${m}`;
  });

  const ctx = document.getElementById('trendChart').getContext('2d');
  if (trendChart) trendChart.destroy();

  if (keys.length === 0) return;

  trendChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'æœˆæ¶ˆè²»',
        data: values,
        borderColor: '#e04444',
        backgroundColor: 'rgba(224, 68, 68, 0.1)',
        fill: true,
        tension: 0.3,
        pointBackgroundColor: '#e04444',
        pointRadius: 4,
        pointHoverRadius: 6,
      }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          ticks: { color: '#9ca3af', font: { size: 11 } },
          grid: { color: 'rgba(255,255,255,0.05)' },
        },
        y: {
          ticks: {
            color: '#9ca3af',
            font: { size: 11 },
            callback: v => fmt(v),
          },
          grid: { color: 'rgba(255,255,255,0.05)' },
        },
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (ctx) => `æ¶ˆè²»: ${fmt(ctx.raw)}`,
            title: (items) => {
              const idx = items[0].dataIndex;
              return keys[idx];
            },
          },
        },
      },
    },
  });
}

// â”€â”€ Habits â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateHabits() {
  if (allPurchases.length === 0) return;

  // Most common shopping day
  const dayCounts = [0, 0, 0, 0, 0, 0, 0];
  allPurchases.forEach(p => {
    if (p.date) {
      const d = new Date(p.date);
      if (!isNaN(d)) dayCounts[d.getDay()]++;
    }
  });
  const maxDayIdx = dayCounts.indexOf(Math.max(...dayCounts));
  document.getElementById('favDay').textContent =
    `${WEEKDAYS[maxDayIdx]}ï¼ˆ${dayCounts[maxDayIdx]} æ¬¡ï¼‰`;

  // Top spending month
  const months = getMonthlyData();
  const topMonthKey = Object.entries(months).sort((a, b) => b[1] - a[1])[0];
  if (topMonthKey) {
    document.getElementById('topMonth').textContent =
      `${topMonthKey[0]} â€” ${fmt(topMonthKey[1])}`;
  }

  // Top category by count
  const catCounts = {};
  allPurchases.forEach(p => {
    const c = p.category || 'å…¶ä»–';
    catCounts[c] = (catCounts[c] || 0) + 1;
  });
  const topCat = Object.entries(catCounts).sort((a, b) => b[1] - a[1])[0];
  if (topCat) {
    document.getElementById('topCategory').textContent =
      `${topCat[0]}ï¼ˆ${topCat[1]} æ¬¡ï¼‰`;
  }

  // Purchase frequency
  if (allPurchases.length >= 2) {
    const dates = allPurchases
      .map(p => p.date ? new Date(p.date).getTime() : null)
      .filter(d => d !== null)
      .sort();
    if (dates.length >= 2) {
      const span = dates[dates.length - 1] - dates[0];
      const days = span / (1000 * 60 * 60 * 24);
      const freq = days / (dates.length - 1);
      document.getElementById('frequency').textContent =
        freq < 1 ? 'æ¯å¤©' : `ç´„æ¯ ${Math.round(freq)} å¤©`;
    }
  }
}

// â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTable() {
  const tbody = document.getElementById('ordersBody');
  const empty = document.getElementById('emptyState');
  const table = document.querySelector('#tableContent table');

  if (filteredPurchases.length === 0 && allPurchases.length === 0) {
    showEmptyState();
    return;
  }

  empty.style.display = 'none';
  table.style.display = '';

  tbody.innerHTML = filteredPurchases.map(p => `
    <tr>
      <td>${escapeHtml(p.date || 'â€”')}</td>
      <td>${escapeHtml(p.name || 'â€”')}</td>
      <td><span class="category-badge">${escapeHtml(p.category || 'å…¶ä»–')}</span></td>
      <td class="price">${fmt(p.price || 0)}</td>
      <td>${escapeHtml(p.status || 'â€”')}</td>
    </tr>
  `).join('');
}

function showEmptyState() {
  document.getElementById('emptyState').style.display = '';
  const table = document.querySelector('#tableContent table');
  if (table) table.style.display = 'none';
}

function escapeHtml(s) {
  const div = document.createElement('div');
  div.textContent = s;
  return div.innerHTML;
}

// â”€â”€ Start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();
</script>

</body>
</html>
